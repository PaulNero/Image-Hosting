# Image Hosting Service

Сервис для хранения и раздачи изображений через веб-интерфейс.

## Возможности

- Загрузка изображений через веб-форму
- Поддержка форматов: JPG, PNG, GIF
- Просмотр загруженных изображений в режиме галереи или таблицы
- Прямые ссылки на изображения
- Удаление изображений
- Пагинация списка изображений
- Резервное копирование базы данных

## Технологии

- Python 3.11
- Nginx
- Docker & Docker Compose
- PostgreSQL 15

## Запуск

```bash
# Сборка и запуск контейнеров
docker compose up --build

# Или с помощью скрипта
./commands/app_up.sh

# Остановка контейнеров
docker compose down

# Или с помощью скрипта
./commands/app_down.sh

# Перезапуск контейнеров
./commands/app_restart.sh
```

## Использование

После запуска сервис доступен по адресам:
- Главная страница: http://localhost
- Загрузка файлов: http://localhost/upload
- Просмотр изображений: http://localhost/all_images.html или http://localhost/images-list

## API

### Загрузка изображения
- URL: `/upload`
- Метод: `POST`
- Формат: `multipart/form-data`
- Ограничения: 
  - Максимальный размер файла: 5MB
  - Поддерживаемые форматы: jpg, jpeg, png, gif

### Получение изображения
- URL: `/images/<filename>`
- Метод: `GET`
- Ответ: Файл изображения

### Просмотр всех изображений (веб-интерфейс)
- URL: `/all_images.html` или `/images-list`
- Метод: `GET`
- Функциональность:
  - Галерейное отображение (сетка изображений, 15 на странице)
  - Табличное отображение (с метаданными, 25 на странице)
  - Переключение между представлениями
  - Предпросмотр изображений
  - Удаление изображений

### Список изображений (API)
- URL: `/api/images`
- Метод: `GET`
- Параметры:
  - `page`: номер страницы (по умолчанию 1)
  - `per_page`: количество изображений на странице (по умолчанию 10, максимум 50)
- Ответ: JSON с данными о изображениях на указанной странице
- Пример ответа:
```json
{
  "images": [
    {
      "id": 1,
      "filename": "a1b2c3d4.jpg",
      "original_name": "photo.jpg",
      "size": 12345,
      "file_type": "jpg",
      "upload_time": "2023-05-01T12:34:56"
    }
  ],
  "total": 42,
  "page": 1,
  "per_page": 10
}
```

### Удаление изображения через API
- URL: `/api/images/<filename>`
- Метод: `DELETE`
- Ответ: JSON с результатом операции

### Удаление изображения через веб-интерфейс
- URL: `/delete/<id>`
- Метод: `GET`
- Действие: Удаляет изображение с указанным ID и перенаправляет на страницу списка

## Структура базы данных

База данных PostgreSQL содержит таблицу `images` со следующей структурой:

```sql
CREATE TABLE images (
    id SERIAL PRIMARY KEY,
    filename TEXT NOT NULL UNIQUE,
    original_name TEXT NOT NULL,
    size INTEGER NOT NULL,
    file_type VARCHAR(10) NOT NULL,
    upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

- `id`: Уникальный идентификатор изображения
- `filename`: Сгенерированное имя файла на сервере
- `original_name`: Оригинальное имя файла, загруженного пользователем
- `size`: Размер файла в байтах
- `file_type`: Формат файла (jpg, png, gif)
- `upload_time`: Дата и время загрузки

## Пагинация

Система поддерживает гибкую пагинацию, адаптированную под разные виды представления:

- **Галерейное представление (Grid)**: По умолчанию 15 изображений на странице
- **Табличное представление (Table)**: По умолчанию 25 изображений на странице

При использовании API вы можете указать желаемое количество изображений через параметр `per_page`:
```
GET /api/images?page=2&per_page=20
```

Ограничения:
- Минимальное значение `per_page`: 1
- Максимальное значение `per_page`: 50
- Если параметр не указан, используется значение по умолчанию (10)

## Структура проекта

```
.
├── app/                # Директория приложения
│   ├── app.py          # Основной файл приложения
│   ├── handlers/       # Обработчики запросов
│   │   ├── AdvancedHandler.py    # Базовый обработчик HTTP-запросов
│   │   ├── FileHandler.py        # Обработчик файлов
│   │   └── ImageHostingHandler.py # Обработчик изображений
│   ├── db/             # Работа с базой данных
│   │   ├── DBManager.py          # Менеджер подключения к БД
│   │   └── init_tables.sql       # SQL для инициализации таблиц
│   └── utils/          # Утилиты
├── config/             # Конфигурационные файлы
│   ├── docker/         # Docker-конфигурация
│   │   ├── docker-compose.yml
│   │   └── Dockerfile
│   ├── nginx/          # Конфигурация Nginx
│   ├── settings.py     # Настройки приложения
│   └── logger_setup.py # Настройка логирования
├── data/               # Данные
│   ├── images/         # Директория для загруженных изображений
│   ├── logs/           # Директория для логов
│   ├── backups/        # Директория для резервных копий
│   └── static/         # Статические файлы (HTML, CSS, JS)
└── commands/           # Скрипты для управления приложением
    ├── app_up.sh       # Запуск приложения
    ├── app_down.sh     # Остановка приложения
    ├── app_restart.sh  # Перезапуск приложения
    ├── db_backup.sh    # Создание резервной копии БД
    ├── db_restore.sh   # Восстановление из резервной копии
    └── db_setup_cron.sh # Настройка автоматических бэкапов
```

## Резервное копирование

### Создание резервной копии вручную

```bash
# Создание резервной копии базы данных
./commands/db_backup.sh
```

Резервная копия будет сохранена в директории `data/backups` с именем, содержащим текущую дату и время.

### Настройка автоматического резервного копирования

```bash
# Настройка cron-задачи для ежедневного резервного копирования
./commands/db_setup_cron.sh
```

Скрипт добавит задачу в crontab для создания резервной копии ежедневно в 3:00.

### Восстановление из резервной копии

```bash
# Восстановление базы данных из резервной копии
./commands/db_restore.sh data/backups/backup_YYYY-MM-DD_HHMMSS.sql
```

## Управление приложением

```bash
# Запуск
./commands/app_up.sh

# Остановка
./commands/app_down.sh

# Перезапуск
./commands/app_restart.sh
```

## Ограничения

- Максимальный размер загружаемого файла: 5MB
- Поддерживаемые форматы: jpg, jpeg, png, gif
- Изображения хранятся в Docker volume
- Логи сохраняются в Docker volume

## Безопасность

- Проверка MIME-типов загружаемых файлов
- Генерация уникальных имен файлов
- Ограничение размера загружаемых файлов
- Защита от загрузки вредоносных файлов 